# nambo_memo

## 概要
nambo_memo（なんぼメモ）Flutterアプリ開発の文脈で、価格記録・比較・履歴参照・期間別最安値確認を中心にMVPから段階拡張する方針を確定。主画面は入力/一覧（履歴）/設定で、一覧から商品詳細へ遷移して価格推移グラフと店舗情報を

## ログ

### 2026-02-15 19:12
- 実施内容:
  - nambo_memo（なんぼメモ）Flutterアプリ開発の文脈で、価格記録・比較・履歴参照・期間別最安値確認を中心にMVPから段階拡張する方針を確定。主画面は入力/一覧（履歴）/設定で、一覧から商品詳細へ遷移して価格推移グラフと店舗情報を確認できる構成。店舗は「イオン」「イオン 野田阪神店」のように粗粒度/詳細粒度の両立入力を許容し、お気に入り店舗を選択時に上位表示する。商品名もジャンル名（例: 納豆）と個別名（例: ○○納豆）を併用管理し、タグ/カテゴリ付与とお気に入り商品ジャンルのクイック導線を用意。最安値参照は「半年以内（デフォルト）/1年以内/3年以内/全期間」で切替可能。商品詳細から価格追加入力と備考入力を可能にする。単位は個・本・枚などの離散単位に加え、セット数（サブ個数）を保持し1個あたり単価を内部計算。g/kg/ml等の連続量単位は100g/100ml換算値を自動表示する。広告は将来表示前提で配置・設計のみ先行し、開発中は非表示。同期はまずローカル中心で進め、将来のバックアップやスプレッドシート連携を見据える。実装面ではRiverpodへの整理、Repository抽象化、Dio+Retrofitのremote基盤、Local/Remote切替、同期失敗バナー（再試行/閉じる）まで進行。コミットは小分け・日本語メッセージ、README/コメント日本語で進める運用を継続。

### 2026-02-18 21:48
- 実施内容:
  - nambo_memo の直近実装は、品目主軸入力と税区分UI整理を中心に改善した。
  - - 初期データとID整合: 初期商品のIDを `tamanegi` / `chikin` / `tissue` 系で運用し、初期PriceRecordのproductId参照不整合を修正。商品名は品目主軸のため玉ねぎ/鶏むね肉は商品名空運用、ティッシュ商品名は `ABCティッシュ` に変更。
  - - 入力フォームUX: 品目を商品名より上に配置。商品名は任意扱い。品目・商品名（編集画面含む）にクリアボタン追加。品目クリア時は商品名/カテゴリも初期化。商品名クリア時はロック解除し、タグも初期化。
  - - ロック不具合修正: 商品名空文字時に既存空商品名へ誤マッチして品目が固定されるバグを修正（_syncProductNameで空入力時は即ロック解除）。
  - - サジェスト改善: 品目サジェストは直近入力（records）を先頭優先。商品名サジェストは品目選択時にその品目に紐づく商品名のみに絞り込み。カテゴリサジェストも直近入力カテゴリを先頭優先に変更。
  - - 税区分UIの見直し: 誤解を避けるため税選択を3択に統一。
  - `[税抜] [税込 8%] [税込 10%]`
  - 内部プリセットも `excluded / included8 / included10` に整理し、商品追加初回価格と価格追加シートの両方に反映。
  - - テスト整備: app_test / state_notifier_test を新ID・新表示・新税キーへ全面追従し、回帰テストを追加。最終的に analyze/test は通過。
  - - 直近コミット:
  - - 8319304 refactor: 品目主軸入力の整合性修正とテスト更新
  - - 73de5d1 fix: 税区分を税抜・税込8%・税込10%の3択に統一

### 2026-02-18 21:48
- 実施内容:
  - nambo_memo の直近実装は、品目主軸入力と税区分UI整理を中心に改善した。
  - - 初期データとID整合: 初期商品のIDを `tamanegi` / `chikin` / `tissue` 系で運用し、初期PriceRecordのproductId参照不整合を修正。商品名は品目主軸のため玉ねぎ/鶏むね肉は商品名空運用、ティッシュ商品名は `ABCティッシュ` に変更。
  - - 入力フォームUX: 品目を商品名より上に配置。商品名は任意扱い。品目・商品名（編集画面含む）にクリアボタン追加。品目クリア時は商品名/カテゴリも初期化。商品名クリア時はロック解除し、タグも初期化。
  - - ロック不具合修正: 商品名空文字時に既存空商品名へ誤マッチして品目が固定されるバグを修正（_syncProductNameで空入力時は即ロック解除）。
  - - サジェスト改善: 品目サジェストは直近入力（records）を先頭優先。商品名サジェストは品目選択時にその品目に紐づく商品名のみに絞り込み。カテゴリサジェストも直近入力カテゴリを先頭優先に変更。
  - - 税区分UIの見直し: 誤解を避けるため税選択を3択に統一。
  - `[税抜] [税込 8%] [税込 10%]`
  - 内部プリセットも `excluded / included8 / included10` に整理し、商品追加初回価格と価格追加シートの両方に反映。
  - - テスト整備: app_test / state_notifier_test を新ID・新表示・新税キーへ全面追従し、回帰テストを追加。最終的に analyze/test は通過。
  - - 直近コミット:
  - - 8319304 refactor: 品目主軸入力の整合性修正とテスト更新
  - - 73de5d1 fix: 税区分を税抜・税込8%・税込10%の3択に統一

### 2026-02-18 23:25
- 実施内容:
  - nambo_memo直近は、一覧/お気に入り/設定導線再編の仕上げ後に、価格入力UXとカテゴリ管理を大きく拡張した。
  - - 一覧/お気に入り/設定導線の整理を実装し、厳しめレビューと修正を経てコミット。
  - - 4d2984b feat: お気に入りタブ追加と管理導線を整理
  - - 価格入力に「記録日」選択を追加し、入力欄の視認性向上（左アイコン）を実装。
  - - 02a21ba feat: 価格入力に記録日指定と入力アイコンを追加
  - - 単位とカテゴリの要件拡張を実装。
  - - 単位: 候補選択 + 自由入力に対応。PriceRecordへ customUnitLabel を追加し、表示・CSV・保存へ反映。
  - - カテゴリ: マスタ管理を追加。入力タブでカテゴリ候補を追加可能、設定にカテゴリ管理画面（編集/未使用削除）を追加。
  - - 永続化: AppRepository/RecordStorage/NamboState に categories の load/save を追加し、商品追加/更新/インポート時に同期。
  - - 生成コード更新: build_runnerで models.freezed.dart / models.g.dart を再生成。
  - - コミット: 0e783ac feat: 単位入力UX改善とカテゴリ管理機能を追加
  - - 単位UIの最終調整要望に対応。
  - - 「個数の右側アイコン押下でポップアップ選択し、単位欄へ反映」に変更。
  - - 単位サジェスト（チップ）表示は削除。
  - 検証状況:
  - - 各変更タイミングで flutter analyze と flutter test（または app_test）を実行し、最終状態は全件成功。
  - 現状態メモ:
  - - ブランチ: master
  - - 主要未反映（未コミット）変更は、単位入力欄の右アイコン化 + ポップアップ選択 + サジェスト削除の最終UX調整。

### 2026-02-19 01:48
- 実施内容:
  - nambo_memo 開発継続メモ: 直近で価格推移・単価推移のUX改善、単位切替、最安値表示仕様変更、店舗数サマリー修正を実施。
  - - 直近のユーザー要望に対応した主な実装:
  - - 商品詳細グラフの可読性改善（文字サイズ拡大、ラベル強調、点ラベルを前面描画）
  - - 単価推移の切替追加: 100g/1kg と 100ml/1L（単価推移カード右側ボタン）
  - - 価格推移はサブ数量1つ分の税込価格表示へ変更
  - - 価格推移ラベルは「金額 / 数量単位」表示、サブ数量文言は非表示
  - - 最安値（期間フィルタ適用）は単価基準で判定し、金額と数量をセット表示に変更
  - - 商品詳細から価格追加する際の日付初期値を当日に変更（編集時のみ既存日付を維持）
  - - 設定のデータサマリー「登録店舗数」を records + stores から算出したユニーク店舗数へ修正
  - - テスト/検証状況:
  - - 各変更時に flutter analyze と該当 widget test を実施
  - - 最新時点で flutter test 全件成功（82件）を確認済み
  - - 直近コミット（日本語メッセージ）:
  - - 23b1a3b データサマリーの登録店舗数表示をテストで固定確認
  - - 6fa204f 商品詳細の価格追加で日付初期値を当日にする
  - - 6396fd1 最安値表示を単価基準の金額・数量に変更
  - - 7ae84da 価格推移をサブ数量1つ分の単価表示に変更
  - - 276800e グラフの金額ラベルを前面表示に調整
  - - 8ee1d07 詳細画面の長押し編集テストを安定化
  - - 42fdf53 グラフと全体テキストの可読性をスマホ向けに改善
  - - ecb6746 単価推移の単位切替とグラフ表示を改善
  - - 現在のワークツリー:
  - - 最後に「価格推移ラベルから1つ分文言を削除」まで反映済みで、解析は成功
  - - 直前ユーザー要望「カラーリングやデザインをシンプルで見やすく」は未着手（ターン中断）
  - - 今後の再開ポイント:
  - - 配色・タイポ・余白・カード階層を整える軽量UIリファインを、既存情報設計を維持して実施する。

### 2026-02-19 23:01
- 実施内容:
  - Flutterアプリ nambo_memo の開発を継続中。直近ではAndroidエミュレータでの起動確認が完了し、ユーザー環境で表示も確認済み。Android Studioのエミュレータ表示はツールウィンドウ内/別ウィンドウの切替方法を案内済み。今回の会話では「ホットブート」ではなく Flutter の自動反映として Hot Reload/Hot Restart の使い方を整理し、`flutter run` 中に `r`（Hot Reload）/`R`（Hot Restart）を使うこと、通常は `r` を使う運用を案内。起動コマンドは `cd ~/Source/nambo_memo && flutter run -d emulator-5554` を案内し、フルパス指定不要で運用できる前提を共有した。

### 2026-02-20 08:31
- 実施内容:
  - nambo_memoのデータ構造を厳しめにレビューし、指摘1〜4（storeId/store整合、addProduct保存失敗ロールバック、マスタ表記ゆれ重複、空商品名の未分類退避衝突）をすべて解決した。実装として、loadRecordsのnull/空配列挙動を整理、孤児productIdレコード除外、不正itemId商品の未分類退避、toggleProductFavoriteのロールバック、addProductの失敗時巻き戻し、カテゴリ/品目の正規化キー比較（trim/lower/空白圧縮）を追加。テストはstate_notifier_testに複数ケース（保存失敗ロールバック、重複抑止、退避衝突回避、storeId再正規化）を追加し、flutter analyze/test全件通過を確認。コミットは 503c9d8, fb84dc6, 98a983b, 7d62ff9, f2c7ea0。現時点で未対応の厳しめレビュー残課題は、addProductの部分成功時の永続層不整合リスク、ロールバックの全state復元による並行更新潰し、変更系メソッドの失敗時ポリシー不統一、storeId/store二重保持の構造的冗長、Unicodeレベルの表記ゆれ正規化不足。

### 2026-02-21 16:08
- 実施内容:
  - nambo_memo: 折れ線グラフのラベル表示仕様を大幅改修。常時表示はmin/max/lastのみ、重複時優先順位はlast>max>min、その他点はタップ時ツールチップ表示に変更。グラフ点と目盛り・グリッドの座標系を統一し、Y位置ズレを解消。価格ラベルは「金額/数量単位」形式（例: 800円/2kg）に更新。商品詳細の最近記録はrecordedAt降順（上が最新）に修正。
  - 加えて単位体系を拡張し、既存のg/kg・ml/Lに加えてcm/mを実装。変更範囲は以下。
  - - lib/core/models.dart: UnitTypeにlength追加、Unitにcentimeter/meter追加、normalizedUnitPriceとnormalizedUnitLabelへlength処理追加。
  - - lib/core/models.g.dart: enum mapへcentimeter/meter追加。
  - - lib/core/record_storage.dart: DB versionを11へ更新、price_records.unitのCHECK制約へcentimeter/meter追加、upgrade条件更新。
  - - lib/app/ui_helpers.dart: 単位候補へcm/m追加、convertQuantityByUnitChangeにcm<->m換算追加。
  - - lib/app/product_detail_page.dart: 単価推移にlength系切替（cm/m）を追加、Y軸ラベル・ChoiceChip・単価計算を対応。
  - - test/app_test.dart: cm<->m換算テスト追加、length単価切替Widgetテスト追加。
  - コミット履歴（直近）:
  - - ed338cc グラフラベルをmin/max/最新に限定しタップツールチップを追加
  - - 37ffc9e 長さ単位cm/mの換算と単価表示切替に対応
  - その後、日本語入力不能問題をデバッグ。アプリ側ではIME確定前(composing中)の再描画干渉対策として入力欄のonChangedにガードを追加。
  - - lib/app/input_page.dart: 品目/商品名 onChangedでcomposing中は同期処理をスキップ
  - - lib/app/settings_management_pages.dart: 商品編集シート（商品名/品目/カテゴリ/タグ）でcomposing中はsetStateを抑制
  - 環境側ではエミュレータのGboard問題が主因。adbでIME確認後、`pm clear com.google.android.inputmethod.latin` 実行で復旧し、日本語（ひらがな/漢字変換）が正常化。

### 2026-02-22 12:13
- 実施内容:
  - nambo_memoのUI/UX改善を継続。商品詳細ページの価格追加導線を右下ボタンへ統一し、最終的にFloatingActionButton.extended（「+ 価格を追加」）に変更。画面内の重複「価格を追加」ボタンは削除。追加処理は_product_detail_page.dartで_openAddRecordSheetに共通化して既存挙動（保存・失敗時スナックバー・ローカル反映）を維持。入力タブの既存商品名サジェスト選択時に購入日（記録日）が最新履歴で上書きされるバグを修正（_initialRecordedAtの上書き削除）。回帰防止としてapp_testに「商品名選択時に記録日は上書きしない」を追加し、関連テストを通過。
  - その後、追加系の＋ボタンをデザイン統一。対象は「入力タブの購入店舗＋」「入力タブのタグ＋」「一覧の商品追加＋」「カテゴリ管理＋」「店舗管理＋」「商品詳細の価格追加シート内の購入店舗＋」。ui_helpers.dartに共通ヘルパーbuildAddActionIconButtonと色定数kAddActionButtonColorを導入し、各箇所を置換。色は濃すぎるフィードバックに対応して価格追加系と同じteal（0xFF009688）に調整。機能キーは維持。
  - 直近コミット:
  - - 5ddbe94 商品詳細の価格追加導線を右下拡張FABに統一
  - - 1d27975 追加アクションの＋ボタンを共通スタイルに統一
  - 検証は都度実施し、flutter analyzeと関連widget test（詳細価格追加、入力タブ店舗＋、一覧商品追加、カテゴリ管理追加、店舗管理追加、価格追加シート店舗候補）を通過済み。現在ブランチはmasterで、未コミット変更はない状態。
